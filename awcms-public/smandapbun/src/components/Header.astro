---
import { Icon } from "astro-icon/components";
import {
  getLocalizedPath,
  type Locale,
  supportedLocales,
  defaultLocale,
} from "../utils/i18n";
import navigation from "../data/navigation.json";
import site from "../data/site.json";

export interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
const currentPath = Astro.url.pathname;

function getLabel(item: any): string {
  return item.label[locale] || item.label[defaultLocale];
}
---

<header class="bg-white shadow-sm sticky top-0 z-50">
  <!-- Top Bar -->
  <div class="bg-primary-600 text-white py-2">
    <div
      class="container-custom flex flex-wrap justify-between items-center text-sm"
    >
      <div class="flex items-center gap-4">
        <a
          href={`mailto:${site.site.email}`}
          class="flex items-center gap-1 hover:text-secondary-300 transition-colors"
        >
          <Icon name="tabler:mail" class="w-4 h-4" />
          <span class="hidden sm:inline">{site.site.email}</span>
        </a>
        <a
          href={`tel:${site.site.phone}`}
          class="flex items-center gap-1 hover:text-secondary-300 transition-colors"
        >
          <Icon name="tabler:phone" class="w-4 h-4" />
          <span class="hidden sm:inline">{site.site.phone}</span>
        </a>
      </div>
      <div class="flex items-center gap-3">
        <!-- Social Media -->
        <div class="hidden md:flex items-center gap-2">
          <a
            href={site.site.socialMedia.facebook}
            target="_blank"
            rel="noopener"
            class="hover:text-secondary-300 transition-colors"
          >
            <Icon name="tabler:brand-facebook" class="w-4 h-4" />
          </a>
          <a
            href={site.site.socialMedia.instagram}
            target="_blank"
            rel="noopener"
            class="hover:text-secondary-300 transition-colors"
          >
            <Icon name="tabler:brand-instagram" class="w-4 h-4" />
          </a>
          <a
            href={site.site.socialMedia.youtube}
            target="_blank"
            rel="noopener"
            class="hover:text-secondary-300 transition-colors"
          >
            <Icon name="tabler:brand-youtube" class="w-4 h-4" />
          </a>
        </div>
        <!-- Language Switcher -->
        <div
          class="flex items-center gap-1 border-l border-primary-400 pl-3 ml-2"
        >
          {
            supportedLocales.map((lang) => (
              <a
                href={
                  lang === defaultLocale
                    ? currentPath.replace(`/${locale}`, "") || "/"
                    : `/${lang}${currentPath}`
                }
                class={`px-2 py-0.5 rounded text-xs font-medium transition-colors ${
                  locale === lang
                    ? "bg-white text-primary-600"
                    : "hover:bg-primary-500"
                }`}
              >
                {lang.toUpperCase()}
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Main Navigation -->
  <div class="container-custom py-3">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <a href={getLocalizedPath("/", locale)} class="flex items-center gap-3">
        <div
          class="w-12 h-12 bg-primary-600 rounded-full flex items-center justify-center text-white font-bold text-lg"
        >
          S2
        </div>
        <div>
          <div class="font-bold text-lg text-primary-600 leading-tight">
            {site.site.name}
          </div>
          <div class="text-xs text-gray-500">{site.site.tagline}</div>
        </div>
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden lg:flex items-center gap-1" id="desktop-nav">
        {
          navigation.mainMenu.map((item) => (
            <div class="relative group">
              <a
                href={getLocalizedPath(item.href, locale)}
                class={`nav-link px-3 py-2 rounded-lg flex items-center gap-1 ${
                  currentPath === item.href ||
                  currentPath.startsWith(item.href + "/")
                    ? "nav-link-active bg-primary-50"
                    : "hover:bg-gray-50"
                }`}
                data-testid={`nav-${item.id}`}
              >
                {getLabel(item)}
                {item.children && (
                  <Icon name="tabler:chevron-down" class="w-4 h-4" />
                )}
              </a>

              {item.children && (
                <div class="absolute left-0 top-full pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                  <div class="bg-white rounded-lg shadow-xl border border-gray-100 py-2 min-w-[220px]">
                    {item.children.map((child: any) => (
                      <div>
                        <a
                          href={getLocalizedPath(child.href, locale)}
                          class="block px-4 py-2 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-600 transition-colors"
                          data-testid={`nav-${child.id}`}
                        >
                          {getLabel(child)}
                        </a>
                        {child.children && (
                          <div class="pl-4">
                            {child.children.map((subChild: any) => (
                              <a
                                href={getLocalizedPath(subChild.href, locale)}
                                class="block px-4 py-1.5 text-xs text-gray-500 hover:bg-primary-50 hover:text-primary-600 transition-colors"
                                data-testid={`nav-${subChild.id}`}
                              >
                                {getLabel(subChild)}
                              </a>
                            ))}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ))
        }
      </nav>

      <!-- Mobile Menu Button -->
      <button
        class="lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors"
        id="mobile-menu-btn"
        aria-label="Toggle menu"
        data-testid="mobile-menu-btn"
      >
        <Icon
          name="tabler:menu-2"
          class="w-6 h-6 text-gray-700"
          id="menu-icon"
        />
        <Icon
          name="tabler:x"
          class="w-6 h-6 text-gray-700 hidden"
          id="close-icon"
        />
      </button>
    </div>
  </div>

  <!-- Mobile Navigation -->
  <div
    class="lg:hidden hidden bg-white border-t border-gray-100"
    id="mobile-menu"
  >
    <nav class="container-custom py-4 space-y-2">
      {
        navigation.mainMenu.map((item) => (
          <div class="space-y-1">
            <a
              href={getLocalizedPath(item.href, locale)}
              class={`block px-4 py-2 rounded-lg font-medium ${
                currentPath === item.href ||
                currentPath.startsWith(item.href + "/")
                  ? "bg-primary-50 text-primary-600"
                  : "text-gray-700 hover:bg-gray-50"
              }`}
            >
              {getLabel(item)}
            </a>
            {item.children && (
              <div class="pl-4 space-y-1">
                {item.children.map((child: any) => (
                  <a
                    href={getLocalizedPath(child.href, locale)}
                    class="block px-4 py-1.5 text-sm text-gray-600 hover:text-primary-600"
                  >
                    {getLabel(child)}
                  </a>
                ))}
              </div>
            )}
          </div>
        ))
      }
    </nav>
  </div>
</header>

<script>
  const mobileMenuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");

  mobileMenuBtn?.addEventListener("click", () => {
    mobileMenu?.classList.toggle("hidden");
    menuIcon?.classList.toggle("hidden");
    closeIcon?.classList.toggle("hidden");
  });
</script>
