---
import { getBinding } from "~/utils/config";
import {
    getSidebarConfig,
    isActivePath,
    type SidebarConfig,
} from "~/lib/sidebar";
import { createClientFromEnv } from "~/lib/supabase";
import { Icon } from "astro-icon/components";

export interface Props {
    className?: string;
    defaultConfig?: SidebarConfig;
}

const { className = "", defaultConfig } = Astro.props;

// Get tenant context from locals
const tenant_id = Astro.locals.tenant_id || null;
const currentPath = Astro.url.pathname;

// Create Supabase client
const supabase = createClientFromEnv(
    Astro.locals.runtime?.env || import.meta.env,
);

let config = defaultConfig;

// Fetch config if not provided
if (!config && supabase) {
    config = await getSidebarConfig(supabase, "public_sidebar", tenant_id);
}

// Fallback config if nothing found
if (!config) {
    config = {
        groups: [],
        collapsible: true,
        show_icons: true,
        compact_mode: false,
    };
}

const { groups, show_icons } = config;
---

<aside
    class:list={[
        "flex flex-col w-64 h-screen px-4 py-8 overflow-y-auto bg-white border-r rtl:border-r-0 rtl:border-l dark:bg-gray-900 dark:border-gray-700",
        className,
    ]}
>
    <div class="flex flex-col justify-between flex-1 mt-6">
        <nav>
            {
                groups.map((group, groupIndex) => (
                    <div class:list={[groupIndex > 0 ? "mt-6" : ""]}>
                        {group.title && (
                            <h3 class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">
                                {group.title}
                            </h3>
                        )}

                        <div class="space-y-1">
                            {group.items.map((item) => {
                                const active = isActivePath(
                                    item.href,
                                    currentPath,
                                );
                                const hasChildren =
                                    item.children && item.children.length > 0;

                                return (
                                    <div>
                                        <a
                                            href={item.href}
                                            class:list={[
                                                "flex items-center px-4 py-2 text-sm font-medium rounded-lg transition-colors duration-200",
                                                active
                                                    ? "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
                                                    : "text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-gray-200",
                                            ]}
                                        >
                                            {show_icons && item.icon && (
                                                <Icon
                                                    name={item.icon}
                                                    class="w-5 h-5 mr-3 rtl:ml-3 rtl:mr-0 opacity-75"
                                                />
                                            )}

                                            <span class="flex-1">
                                                {item.title}
                                            </span>

                                            {item.badge && (
                                                <span
                                                    class:list={[
                                                        "px-2 py-0.5 ml-auto text-xs font-medium rounded-full",
                                                        item.badge_color
                                                            ? `bg-[${item.badge_color}]/10 text-[${item.badge_color}]`
                                                            : "bg-primary/10 text-primary",
                                                    ]}
                                                >
                                                    {item.badge}
                                                </span>
                                            )}

                                            {hasChildren && (
                                                <Icon
                                                    name="tabler:chevron-down"
                                                    class="w-4 h-4 ml-2 rtl:ml-0 rtl:mr-2 opacity-50"
                                                />
                                            )}
                                        </a>

                                        {hasChildren && active && (
                                            <div class="mt-1 space-y-1 pl-11 rtl:pl-0 rtl:pr-11">
                                                {item.children?.map((child) => {
                                                    const childActive =
                                                        isActivePath(
                                                            child.href,
                                                            currentPath,
                                                        );

                                                    return (
                                                        <a
                                                            href={child.href}
                                                            class:list={[
                                                                "block px-4 py-1.5 text-sm font-medium rounded-lg transition-colors duration-200",
                                                                childActive
                                                                    ? "text-primary dark:text-primary"
                                                                    : "text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",
                                                            ]}
                                                        >
                                                            {child.title}
                                                        </a>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                ))
            }
        </nav>
    </div>
</aside>
