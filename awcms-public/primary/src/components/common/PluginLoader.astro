---
/**
 * PluginLoader.astro - Loads and renders plugin scripts at the appropriate positions.
 *
 * Place in Layout.astro to inject plugin scripts into head, body start, or body end.
 */
import { createClientFromEnv } from "~/lib/supabase";
import {
    getActivePlugins,
    getPluginScripts,
    renderPluginScripts,
} from "~/lib/plugins";

export interface Props {
    /** Script position: 'head', 'body_start', or 'body_end' */
    position: "head" | "body_start" | "body_end";
}

const { position } = Astro.props;

// Get tenant from locals (set by middleware)
const tenant_id = Astro.locals.tenant_id || null;

// Create Supabase client
const supabase = createClientFromEnv(
    Astro.locals.runtime?.env || import.meta.env,
);

let scriptsHtml = "";

if (supabase) {
    try {
        const plugins = await getActivePlugins(supabase, tenant_id);
        const scripts = getPluginScripts(plugins, position);
        scriptsHtml = renderPluginScripts(scripts);
    } catch (error) {
        console.error(
            `[PluginLoader] Error loading plugins for ${position}:`,
            error,
        );
    }
}
---

<Fragment set:html={scriptsHtml} />
