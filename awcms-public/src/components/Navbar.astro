---
import { createScopedClient } from '../lib/supabase';
import { tenantUrl } from '../lib/url';
import { Menu, X, ChevronDown } from 'lucide-react';
import DarkModeToggle from './DarkModeToggle';

interface Props {
    tenantSlug?: string;
}

const { tenantSlug: propTenantSlug } = Astro.props;
const { tenant_id, tenant_slug: localTenantSlug, runtime } = Astro.locals;
const env = runtime?.env || {};

// Use prop or fallback to locals
const tenantSlug = propTenantSlug || localTenantSlug || 'primary';

// Initialize Scoped Client
const supabase = createScopedClient({
    'x-tenant-id': tenant_id
}, env);

// Fetch Menu Items for 'main' menu of this tenant
let menuItems = [];
let brandName = "AWCMS";

if (tenant_id && supabase) {
    // 1. Get Tenant Name
    const { data: tenantData } = await supabase
        .from('tenants')
        .select('name')
        .eq('id', tenant_id)
        .single();
    
    if (tenantData) {
        brandName = tenantData.name;
    }

    // 2. Get Main Menu
    const { data: menuData } = await supabase
        .from('menus')
        .select('id')
        .eq('tenant_id', tenant_id)
        .eq('slug', 'main')
        .eq('is_active', true)
        .single();
    
    if (menuData) {
        const { data: items } = await supabase
            .from('menu_items')
            .select('label, url, parent_id, order')
            .eq('menu_id', menuData.id)
            .order('order');
        
        if (items) {
            menuItems = items;
        }
    }
}

// Fallback items if no menu defined
if (menuItems.length === 0) {
    menuItems = [
        { label: 'Home', url: '/' },
        { label: 'Articles', url: '/articles' },
        { label: 'Contact', url: '/contact' },
    ];
}

// Build tenant-aware URLs
const buildUrl = (path: string) => tenantUrl(tenantSlug, path);
---

<header class="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
    <div class="container flex h-16 items-center justify-between">
        <div class="flex items-center gap-6">
            <a href={buildUrl('/')} class="flex items-center space-x-2 font-heading font-bold text-xl text-primary">
                {brandName}
            </a>
            
            <nav class="hidden md:flex items-center gap-6 text-sm font-medium">
                {menuItems.map((item) => (
                    <a 
                        href={buildUrl(item.url)} 
                        class="transition-colors hover:text-foreground/80 text-foreground/60"
                    >
                        {item.label}
                    </a>
                ))}
            </nav>
        </div>

        <div class="flex items-center gap-4">
             {/* Dark Mode Toggle */}
             <DarkModeToggle client:load />
             
             {/* Mobile Menu Trigger */}
             <button class="md:hidden p-2 text-foreground/60">
                 <Menu className="w-6 h-6" />
             </button>
        </div>
    </div>
</header>
